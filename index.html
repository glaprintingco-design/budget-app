<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presupuesto Monge Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { color: #059669; border-top: 2px solid #059669; background-color: #ecfdf5; }
        .loader { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col justify-between bg-slate-50">

    <header class="bg-white shadow-sm p-4 pt-8 sticky top-0 z-10 flex justify-between items-center">
        <h1 class="text-xl font-extrabold text-slate-800">ğŸ’° Monge Budget</h1>
        <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full" id="indicador-mes">...</span>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24">
        
        <div id="tab-registro" class="space-y-5">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <label class="block text-slate-400 text-xs font-bold uppercase mb-3">Usuario</label>
                <div class="flex space-x-3">
                    <button onclick="setPersona('Angel')" id="btn-angel" class="flex-1 py-3 rounded-xl border font-bold text-slate-600">ğŸ‘¨ Angel</button>
                    <button onclick="setPersona('Luisa')" id="btn-luisa" class="flex-1 py-3 rounded-xl border font-bold text-slate-600">ğŸ‘© Luisa</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 space-y-5">
                <div>
                    <label class="block text-slate-600 font-bold mb-2 text-sm">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-4 text-slate-400 text-xl">$</span>
                        <input type="number" id="monto" class="w-full bg-slate-50 border rounded-xl py-4 pl-9 pr-4 text-3xl font-bold focus:ring-2 focus:ring-green-500 outline-none" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-slate-600 font-bold mb-2 text-sm">CategorÃ­a</label>
                    <div class="relative">
                        <select id="categoria" class="w-full bg-slate-50 border rounded-xl py-4 px-4 text-lg text-slate-700 outline-none">
                            <option value="Mercado">ğŸ›’ Mercado</option>
                            <option value="Comida afuera">ğŸ” Comida afuera</option>
                            <option value="Administration">ğŸ¢ Administration</option>
                            <option value="Internet">ğŸŒ Internet</option>
                            <option value="Insurance">ğŸ›¡ï¸ Insurance</option>
                            <option value="Electricity">âš¡ Electricity</option>
                            <option value="Water">ğŸ’§ Water</option>
                            <option value="Gas">ğŸ”¥ Gas</option>
                            <option value="School Bus">ğŸšŒ School Bus</option>
                            <option value="Transportation">ğŸš• Transportation</option>
                            <option value="Cellphone">ğŸ“± Cellphone</option>
                            <option value="Allan">ğŸ‘¦ğŸ» Allan</option>
                            <option value="Angel David">ğŸ‘¦ğŸ» Angel David</option>
                            <option value="Luisa">ğŸ’… Luisa</option>
                            <option value="Angel">ğŸ‘” Angel</option>
                            <option value="Milo">ğŸ¶ Milo</option>
                            <option value="Loan Payment">ğŸ¦ Loan Payment</option>
                            <option value="Credit Card">ğŸ’³ Credit Card</option>
                            <option value="Netflix">ğŸ¬ Netflix</option>
                            <option value="Diezmos y Ofrendas">ğŸ™ Diezmos y Ofrendas</option>
                            <option value="Play">ğŸ® Play</option>
                            <option value="Savings">ğŸ· Savings</option>
                            <option value="Regalos">ğŸ Regalos</option>
                            <option value="Home & Repairs">ğŸ› ï¸ Home & Repairs</option>
                            <option value="Vacaciones">âœˆï¸ Vacaciones</option>
                            <option value="Other Expenses">â“ Other Expenses</option>
                            <option value="GLA Enterprise">ğŸ’¼ GLA Enterprise</option>
                            <option value="Girardot Expenses">ğŸ¡ Girardot Expenses</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-slate-600 font-bold mb-2 text-sm">Detalle</label>
                    <input type="text" id="detalle" class="w-full bg-slate-50 border rounded-xl py-4 px-4 outline-none" placeholder="Opcional">
                </div>
                <button onclick="enviarGasto()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">Guardar Gasto</button>
            </div>
        </div>

        <div id="tab-stats" class="hidden space-y-5">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Balance Mes</p>
                    <h3 id="kpi-pnl" class="text-2xl font-black text-slate-800">...</h3>
                    <p id="kpi-msg" class="text-xs font-medium mt-1">Cargando...</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Ahorro Anual</p>
                    <h3 id="kpi-ytd" class="text-xl font-black text-blue-600">...</h3>
                    <p class="text-xs text-blue-400 font-medium mt-1">Acumulado YTD</p>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Flujo de Caja</h2>
                <canvas id="chartBalance" height="220"></canvas>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Control de Presupuesto</h2>
                <div id="lista-metas" class="space-y-4">
                    <p class="text-sm text-slate-400">Cargando desglose...</p>
                </div>
            </div>
            
            <button onclick="cargarDatos()" class="w-full bg-white text-slate-600 font-bold py-3 rounded-xl border border-slate-200">ğŸ”„ Actualizar</button>
        </div>
    </main>

    <nav class="bg-white border-t flex justify-around pb-safe shadow-lg">
        <button onclick="cambiarTab('registro')" id="nav-registro" class="flex-1 py-4 flex flex-col items-center text-slate-400 active-tab">
            <i class="fas fa-plus-circle text-2xl mb-1"></i>
            <span class="text-[10px] font-bold uppercase">Registrar</span>
        </button>
        <button onclick="cambiarTab('stats')" id="nav-stats" class="flex-1 py-4 flex flex-col items-center text-slate-400">
            <i class="fas fa-chart-pie text-2xl mb-1"></i>
            <span class="text-[10px] font-bold uppercase">EstadÃ­sticas</span>
        </button>
    </nav>

    <div id="loading" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-10 w-10 mb-4"></div>
            <p class="font-bold text-slate-600 text-sm">Procesando...</p>
        </div>
    </div>

    <script>
        // CONFIGURACION
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby68h7vCFbnF6vgE_jecsfwluvtVmwPEMz5LzIqsUdZPw2nAqhbq-L2_cT4gO5i-KnF/exec";
        
        // ===============================================
        // TUS METAS
        // ===============================================
        const METAS_PCT = {
            'Girardot Expenses': 10.0, 
            'Home & Repairs': 2.0,
            'Administration': 1.5,
            'Electricity': 1.5,
            'Water': 1.0,
            'Gas': 0.5,
            'Internet': 1.5,
            'Cellphone': 1.0,
            'Mercado': 15.0,        
            'School Bus': 1.0,
            'Transportation': 2.0,
            'Comida afuera': 8.0,  
            'Netflix': 0.5,
            'Play': 0.5,
            'Vacaciones': 5.0,     
            'Milo': 0.5,           
            'Regalos': 1.0,
            'Diezmos y Ofrendas': 10.0, 
            'Allan': 1.0,
            'Angel David': 1.0,
            'Luisa': 5.0,
            'Angel': 5.0,
            'GLA Enterprise': 5.0, 
            'Savings': 10.0,        
            'Loan Payment': 5.0,
            'Credit Card': 8.0,     
            'Insurance': 7.5,
            'Other Expenses': 1.0
        };

        let personaActual = localStorage.getItem('budget_persona') || '';
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        window.onload = () => {
            if(personaActual) setPersona(personaActual);
            document.getElementById('indicador-mes').innerText = meses[new Date().getMonth()];
        };

        function setPersona(nombre) {
            personaActual = nombre;
            localStorage.setItem('budget_persona', nombre);
            document.getElementById('btn-angel').className = `flex-1 py-3 rounded-xl border font-bold transition-all ${nombre === 'Angel' ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-600'}`;
            document.getElementById('btn-luisa').className = `flex-1 py-3 rounded-xl border font-bold transition-all ${nombre === 'Luisa' ? 'bg-pink-50 border-pink-500 text-pink-700' : 'border-slate-200 text-slate-600'}`;
        }

        function cambiarTab(tab) {
            document.getElementById('tab-registro').classList.add('hidden');
            document.getElementById('tab-stats').classList.add('hidden');
            document.getElementById('nav-registro').classList.remove('active-tab', 'text-green-600');
            document.getElementById('nav-stats').classList.remove('active-tab', 'text-green-600');
            
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('nav-' + tab).classList.add('active-tab', 'text-green-600');
            
            if(tab === 'stats') cargarDatos();
        }

        function toggleLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }

        function enviarGasto() {
            const monto = document.getElementById('monto').value;
            const categoria = document.getElementById('categoria').value;
            const detalle = document.getElementById('detalle').value;
            
            if(!personaActual) return alert("âš ï¸ Selecciona usuario");
            if(!monto) return alert("âš ï¸ Ingresa monto");

            toggleLoading(true);
            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoria, monto, detalle, persona: personaActual })
            }).then(() => {
                toggleLoading(false);
                alert("âœ… Guardado");
                document.getElementById('monto').value = '';
                document.getElementById('detalle').value = '';
            }).catch(e => { toggleLoading(false); alert("Error: " + e); });
        }

        let chartBal = null; 

        function cargarDatos() {
            toggleLoading(true);
            const urlFresca = SCRIPT_URL + "?v=" + Math.floor(Math.random() * 10000);
            
            fetch(urlFresca)
                .then(r => r.json())
                .then(data => {
                    toggleLoading(false);
                    if(!data.pnl) {
                        alert("âš ï¸ Error: Datos incompletos del backend.");
                    } else {
                        renderStats(data);
                    }
                })
                .catch(e => { toggleLoading(false); alert("Error de red: " + e); });
        }

        function renderStats(data) {
            const mesIdx = new Date().getMonth();

            // 1. IDENTIFICAR LA CATEGORÃA DE AHORRO (Debe llamarse igual que en tu lista)
            const NOMBRE_CATEGORIA_AHORRO = "Savings"; 
            
            // Buscamos en quÃ© posiciÃ³n estÃ¡ "Savings" en tus datos
            const indexSavings = data.categorias.indexOf(NOMBRE_CATEGORIA_AHORRO);
            
            // Obtenemos los montos de Savings por mes (si no existe, llenamos con ceros)
            const montosSavings = indexSavings >= 0 ? data.detalleGastos[indexSavings] : data.pnl.map(() => 0);

            // 2. RECALCULAR EL PNL (Ahorro Real)
            // Ahorro Real = El PNL que viene del excel + Lo que registraste en la categorÃ­a Savings
            const pnlReal = data.pnl.map((valor, i) => Number(valor) + Number(montosSavings[i]));
            
            // 3. RECALCULAR GASTOS REALES (Sin contar el ahorro como gasto)
            // Gastos Reales = Gastos Totales - Lo que se fue a Savings
            const gastosReales = data.gastosTotal.map((valor, i) => Number(valor) - Number(montosSavings[i]));

            const pnlMes = pnlReal[mesIdx];
            const ytd = pnlReal.reduce((a,b)=>a+b, 0);

            // Formateador de dinero
            const moneyFormatter = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0});

            // KPI Texts
            const elPnl = document.getElementById('kpi-pnl');
            const elMsg = document.getElementById('kpi-msg');
            elPnl.innerText = moneyFormatter.format(pnlMes);
            document.getElementById('kpi-ytd').innerText = moneyFormatter.format(ytd);

            if(pnlMes >= 0) {
                elPnl.className = "text-2xl font-black text-emerald-600";
                elMsg.innerHTML = "âœ… SuperÃ¡vit (+ Ahorro)";
                elMsg.className = "text-xs font-bold text-emerald-600 mt-1";
            } else {
                elPnl.className = "text-2xl font-black text-rose-600";
                elMsg.innerHTML = "âš ï¸ DÃ©ficit";
                elMsg.className = "text-xs font-bold text-rose-600 mt-1";
            }

            // --- CHART ---
            const ctx1 = document.getElementById('chartBalance').getContext('2d');
            if(chartBal) chartBal.destroy();
            chartBal = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: meses.map(m => m.substring(0,3)),
                    datasets: [
                        // La lÃ­nea azul ahora usa pnlReal (Sobrante + Savings Pocket)
                        { type: 'line', label: 'Ahorro Total', data: pnlReal, borderColor: '#2563eb', borderWidth: 2, tension:0.4, order:0 },
                        { label: 'Ingresos', data: data.ingresos, backgroundColor: '#10b981', borderRadius:4, order:1 },
                        // La barra roja ahora usa gastosReales (Todo menos Savings)
                        { label: 'Gastos', data: gastosReales, backgroundColor: '#f43f5e', borderRadius:4, order:2 },
                        // Opcional: Una barrita extra amarilla apilada para visualizar cuÃ¡nto se fue a Savings
                        { label: 'En Bolsillo', data: montosSavings, backgroundColor: '#f59e0b', borderRadius:4, order:3, stack: 'gastos' }
                    ]
                },
                options: { 
                    responsive:true, 
                    plugins:{
                        legend:{position:'bottom'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }, 
                    scales:{
                        x:{grid:{display:false}},
                        y: { stacked: false } // Cambia a true si quieres apilar gastos y savings visualmente
                    } 
                }
            });

            // --- LISTA DE CUMPLIMIENTO DE METAS (Esto queda igual, porque ahÃ­ SÃ quieres ver Savings como una meta a llenar) ---
            const catTotals = data.detalleGastos.map(row => row.reduce((a,b)=> Number(a)+Number(b),0));
            const totalIngresos = data.ingresos.reduce((a,b)=>a+b, 0); 
            const baseCalculo = totalIngresos > 0 ? totalIngresos : 1; 
            
            let categoriasConDatos = [];
            data.categorias.forEach((cat, index) => {
                if(catTotals[index] > 0) {
                    categoriasConDatos.push({
                        nombre: cat,
                        total: catTotals[index],
                        porcentaje: (catTotals[index] / baseCalculo * 100) 
                    });
                }
            });

            categoriasConDatos.sort((a,b) => b.total - a.total);

            const listaDiv = document.getElementById('lista-metas');
            listaDiv.innerHTML = ''; 

            if(categoriasConDatos.length === 0) {
                listaDiv.innerHTML = '<p class="text-center text-slate-400 text-sm">AÃºn no hay gastos registrados este aÃ±o.</p>';
            }

            categoriasConDatos.forEach(cat => {
                const nombre = cat.nombre;
                const realPct = cat.porcentaje.toFixed(1);
                const metaPct = METAS_PCT[nombre] || 5; 
                const formattedMoney = moneyFormatter.format(cat.total);

                // LÃ³gica especial para Savings: Si es Savings, pasarse de la meta es BUENO (Verde), no malo
                let isGood = false;
                if(nombre === 'Savings') {
                    isGood = true; // Siempre verde
                } else {
                    isGood = parseFloat(realPct) <= metaPct; // Verde si gastÃ© menos de la meta
                }

                const colorBarra = isGood ? 'bg-emerald-500' : 'bg-rose-500';
                const colorTexto = isGood ? 'text-slate-600' : 'text-rose-600';
                // Si es Savings y me paso, genial. Si es gasto y me paso, alerta.
                const icono = (nombre !== 'Savings' && !isGood) ? '<i class="fas fa-exclamation-circle text-rose-500"></i>' : '<i class="fas fa-check-circle text-emerald-500"></i>';

                const htmlItem = `
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-3">
                                ${icono}
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold text-slate-700 leading-none">${nombre}</span>
                                    <span class="text-[11px] text-slate-400 font-medium mt-1">${formattedMoney}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-bold ${colorTexto}">${realPct}%</span>
                                <span class="text-[10px] text-slate-400"> / Meta ${metaPct}%</span>
                            </div>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="${colorBarra} h-2 rounded-full" style="width: ${Math.min(realPct, 100)}%"></div>
                        </div>
                    </div>
                `;
                listaDiv.innerHTML += htmlItem;
            });
        }
    </script>
</body>
</html>
