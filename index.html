<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Monge Budget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { color: #059669; border-top: 2px solid #059669; background-color: #ecfdf5; }
        .loader { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .details-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .details-open { max-height: 500px; opacity: 1; }
        .rotate-icon { transition: transform 0.3s; }
        .rotate-down { transform: rotate(180deg); }
    </style>
</head>
<body class="h-screen flex flex-col justify-between bg-slate-50">

    <header class="bg-white shadow-sm p-4 pt-8 sticky top-0 z-10 flex justify-between items-center">
        <h1 class="text-xl font-extrabold text-slate-800">üí∞ Monge Budget</h1>
        <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full" id="indicador-mes">...</span>
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24">
        
        <div id="tab-registro" class="space-y-5">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                <label class="block text-slate-400 text-xs font-bold uppercase mb-3">Usuario</label>
                <div class="flex space-x-3">
                    <button onclick="setPersona('Angel')" id="btn-angel" class="flex-1 py-3 rounded-xl border font-bold text-slate-600">üë® Angel</button>
                    <button onclick="setPersona('Luisa')" id="btn-luisa" class="flex-1 py-3 rounded-xl border font-bold text-slate-600">üë© Luisa</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100 space-y-5">
                <div>
                    <label class="block text-slate-600 font-bold mb-2 text-sm">Monto</label>
                    <div class="relative">
                        <span class="absolute left-4 top-4 text-slate-400 text-xl">$</span>
                        <input type="number" id="monto" class="w-full bg-slate-50 border rounded-xl py-4 pl-9 pr-4 text-3xl font-bold focus:ring-2 focus:ring-green-500 outline-none" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-slate-600 font-bold mb-2 text-sm">Categor√≠a</label>
                    <div class="relative">
                        <select id="categoria" class="w-full bg-slate-50 border rounded-xl py-4 px-4 text-lg text-slate-700 outline-none">
                            <option value="Mercado">üõí Mercado</option>
                            <option value="Comida afuera">üçî Comida afuera</option>
                            <option value="Administration">üè¢ Administration</option>
                            <option value="Internet">üåê Internet</option>
                            <option value="Insurance">üõ°Ô∏è Insurance</option>
                            <option value="Electricity">‚ö° Electricity</option>
                            <option value="Water">üíß Water</option>
                            <option value="Gas">üî• Gas</option>
                            <option value="School Bus">üöå School Bus</option>
                            <option value="Transportation">üöï Transportation</option>
                            <option value="Cellphone">üì± Cellphone</option>
                            <option value="Allan">üë¶üèª Allan</option>
                            <option value="Angel David">üë¶üèª Angel David</option>
                            <option value="Luisa">üíÖ Luisa</option>
                            <option value="Angel">üëî Angel</option>
                            <option value="Milo">üê∂ Milo</option>
                            <option value="Loan Payment">üè¶ Loan Payment</option>
                            <option value="Credit Card">üí≥ Credit Card</option>
                            <option value="Netflix">üé¨ Netflix</option>
                            <option value="Diezmos y Ofrendas">üôè Diezmos y Ofrendas</option>
                            <option value="Play">üéÆ Play</option>
                            <option value="Savings">üê∑ Savings</option>
                            <option value="Regalos">üéÅ Regalos</option>
                            <option value="Home & Repairs">üõ†Ô∏è Home & Repairs</option>
                            <option value="Vacaciones">‚úàÔ∏è Vacaciones</option>
                            <option value="Other Expenses">‚ùì Other Expenses</option>
                            <option value="GLA Enterprise">üíº GLA Enterprise</option>
                            <option value="Girardot Expenses">üè° Girardot Expenses</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-slate-600 font-bold mb-2 text-sm">Detalle</label>
                    <input type="text" id="detalle" class="w-full bg-slate-50 border rounded-xl py-4 px-4 outline-none" placeholder="Opcional">
                </div>
                <button onclick="enviarGasto()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">Guardar Gasto</button>
            </div>
        </div>

        <div id="tab-stats" class="hidden space-y-5">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Balance Mes</p>
                    <h3 id="kpi-pnl" class="text-2xl font-black text-slate-800">...</h3>
                    <p id="kpi-msg" class="text-xs font-medium mt-1">Cargando...</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-1">Ahorro Anual</p>
                    <h3 id="kpi-ytd" class="text-xl font-black text-blue-600">...</h3>
                    <p class="text-xs text-blue-400 font-medium mt-1">Acumulado YTD</p>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Flujo de Caja</h2>
                <canvas id="chartBalance" height="220"></canvas>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Control de Presupuesto</h2>
                <div id="lista-metas" class="space-y-4">
                    <p class="text-sm text-slate-400">Cargando desglose...</p>
                </div>
            </div>
            
            <button onclick="cargarDatos()" class="w-full bg-white text-slate-600 font-bold py-3 rounded-xl border border-slate-200">üîÑ Actualizar</button>
        </div>

        <div id="tab-eker" class="hidden space-y-5">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-6 rounded-2xl shadow-lg text-white">
                <h2 class="text-2xl font-bold mb-1">Filosof√≠a Eker</h2>
                <p class="text-slate-300 text-sm">Distribuci√≥n de los 6 Jarrones</p>
                <div class="mt-4 flex justify-between items-end">
                    <div>
                        <p class="text-xs text-slate-400 uppercase">Ingreso Total</p>
                        <p id="eker-income" class="text-xl font-bold">...</p>
                    </div>
                    <div class="text-right">
                         <p class="text-xs text-slate-400 uppercase">Meta NEC</p>
                         <p class="text-xl font-bold text-emerald-400">50%</p>
                    </div>
                </div>
            </div>

            <div id="lista-eker" class="space-y-4 pb-10">
                <p class="text-center text-slate-400 text-sm mt-10">Carga los datos primero...</p>
            </div>
        </div>

    </main>

    <nav class="bg-white border-t flex justify-around pb-safe shadow-lg">
        <button onclick="cambiarTab('registro')" id="nav-registro" class="flex-1 py-4 flex flex-col items-center text-slate-400 active-tab">
            <i class="fas fa-plus-circle text-2xl mb-1"></i>
            <span class="text-[10px] font-bold uppercase">Registrar</span>
        </button>
        <button onclick="cambiarTab('stats')" id="nav-stats" class="flex-1 py-4 flex flex-col items-center text-slate-400">
            <i class="fas fa-chart-pie text-2xl mb-1"></i>
            <span class="text-[10px] font-bold uppercase">Stats</span>
        </button>
        <button onclick="cambiarTab('eker')" id="nav-eker" class="flex-1 py-4 flex flex-col items-center text-slate-400">
            <i class="fas fa-balance-scale text-2xl mb-1"></i>
            <span class="text-[10px] font-bold uppercase">Eker</span>
        </button>
    </nav>

    <div id="loading" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-10 w-10 mb-4"></div>
            <p class="font-bold text-slate-600 text-sm">Procesando...</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby68h7vCFbnF6vgE_jecsfwluvtVmwPEMz5LzIqsUdZPw2nAqhbq-L2_cT4gO5i-KnF/exec";
        
        // --- 1. CONFIGURACI√ìN DE METAS INDIVIDUALES ---
        const METAS_PCT = {
            'Girardot Expenses': 10.0, 'Home & Repairs': 2.0, 'Administration': 1.5,
            'Electricity': 1.5, 'Water': 1.0, 'Gas': 0.5, 'Internet': 1.5, 'Cellphone': 1.0,
            'Mercado': 15.0, 'School Bus': 1.0, 'Transportation': 2.0, 'Comida afuera': 8.0,  
            'Netflix': 0.5, 'Play': 0.5, 'Vacaciones': 5.0, 'Milo': 0.5, 'Regalos': 1.0,
            'Diezmos y Ofrendas': 10.0, 'Allan': 1.0, 'Angel David': 1.0, 'Luisa': 5.0,
            'Angel': 5.0, 'GLA Enterprise': 5.0, 'Savings': 10.0, 'Loan Payment': 5.0,
            'Credit Card': 8.0, 'Insurance': 7.5, 'Other Expenses': 1.0
        };

        // --- 2. MAPEO DE EKER (CATEGOR√çA -> JARR√ìN) ---
        // Aqu√≠ es donde defines la "Personalidad" de cada gasto
        const EKER_MAP = {
            // NEC (55%) - Necesidades
            'Mercado': 'NEC', 'Administration': 'NEC', 'Electricity': 'NEC', 'Water': 'NEC', 
            'Gas': 'NEC', 'Internet': 'NEC', 'Cellphone': 'NEC', 'School Bus': 'NEC', 
            'Transportation': 'NEC', 'Insurance': 'NEC', 'Home & Repairs': 'NEC', 
            'Loan Payment': 'NEC', 'Credit Card': 'NEC', 'Other Expenses': 'NEC',

            // FFA (10%) - Inversi√≥n / Libertad Financiera
            'Savings': 'FFA', 
            'GLA Enterprise': 'FFA',       // Inversi√≥n en tu negocio
            'Girardot Expenses': 'FFA',    // Inversi√≥n inmobiliaria

            // LTSS (10%) - Ahorro Largo Plazo Gastable
            'Vacaciones': 'LTSS',

            // PLAY (10%) - Juego / Ocio
            'Comida afuera': 'PLAY', 'Netflix': 'PLAY', 'Play': 'PLAY', 'Milo': 'PLAY', 
            'Angel': 'PLAY', 'Luisa': 'PLAY', 'Allan': 'PLAY', 'Angel David': 'PLAY',

            // EDU (10%) - Educaci√≥n
            // (Si tienes cursos, agr√©galos aqu√≠)

            // GIVE (5%) - Dar
            'Diezmos y Ofrendas': 'GIVE', 'Regalos': 'GIVE'
        };

        // Configuraci√≥n visual de los Jarrones
        const JARS_INFO = {
            'NEC': { name: 'Necesidades', target: 50, color: 'bg-blue-500', icon: 'üè†' },
            'FFA': { name: 'Libertad (Inversi√≥n)', target: 10, color: 'bg-yellow-500', icon: 'üöÄ' },
            'LTSS': { name: 'Ahorro Largo Plazo', target: 10, color: 'bg-purple-500', icon: '‚è≥' },
            'EDU': { name: 'Educaci√≥n', target: 10, color: 'bg-pink-500', icon: 'üìö' },
            'PLAY': { name: 'Juego y Ocio', target: 10, color: 'bg-orange-500', icon: 'üéâ' },
            'GIVE': { name: 'Dar / Ofrenda', target: 10, color: 'bg-green-500', icon: 'üôè' }
        };

        let personaActual = localStorage.getItem('budget_persona') || '';
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        let movimientosGlobal = []; // Para el acorde√≥n

        window.onload = () => {
            if(personaActual) setPersona(personaActual);
            document.getElementById('indicador-mes').innerText = meses[new Date().getMonth()];
        };

        function setPersona(nombre) {
            personaActual = nombre;
            localStorage.setItem('budget_persona', nombre);
            document.getElementById('btn-angel').className = `flex-1 py-3 rounded-xl border font-bold transition-all ${nombre === 'Angel' ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-600'}`;
            document.getElementById('btn-luisa').className = `flex-1 py-3 rounded-xl border font-bold transition-all ${nombre === 'Luisa' ? 'bg-pink-50 border-pink-500 text-pink-700' : 'border-slate-200 text-slate-600'}`;
        }

        function cambiarTab(tab) {
            ['registro', 'stats', 'eker'].forEach(t => {
                document.getElementById('tab-' + t).classList.add('hidden');
                document.getElementById('nav-' + t).classList.remove('active-tab', 'text-green-600');
            });
            
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.getElementById('nav-' + tab).classList.add('active-tab', 'text-green-600');
            
            if(tab === 'stats' || tab === 'eker') cargarDatos();
        }

        function toggleLoading(show) { document.getElementById('loading').classList.toggle('hidden', !show); }

        function enviarGasto() {
            const monto = document.getElementById('monto').value;
            const categoria = document.getElementById('categoria').value;
            const detalle = document.getElementById('detalle').value;
            
            if(!personaActual) return alert("‚ö†Ô∏è Selecciona usuario");
            if(!monto) return alert("‚ö†Ô∏è Ingresa monto");

            toggleLoading(true);
            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoria, monto, detalle, persona: personaActual })
            }).then(() => {
                toggleLoading(false);
                alert("‚úÖ Guardado");
                document.getElementById('monto').value = '';
                document.getElementById('detalle').value = '';
            }).catch(e => { toggleLoading(false); alert("Error: " + e); });
        }

        let chartBal = null; 

        function cargarDatos() {
            toggleLoading(true);
            const urlFresca = SCRIPT_URL + "?v=" + Math.floor(Math.random() * 10000);
            
            fetch(urlFresca)
                .then(r => r.json())
                .then(data => {
                    toggleLoading(false);
                    if(!data.pnl) {
                        alert("‚ö†Ô∏è Error: Datos incompletos del backend.");
                    } else {
                        movimientosGlobal = data.movimientos || [];
                        renderStats(data);
                        renderEker(data); // Renderizar tambi√©n el tab Eker
                    }
                })
                .catch(e => { toggleLoading(false); alert("Error de red: " + e); });
        }

        function toggleDetalle(id) {
            const content = document.getElementById('detalle-' + id);
            const icon = document.getElementById('icon-' + id);
            
            if (content.classList.contains('details-open')) {
                content.classList.remove('details-open');
                icon.classList.remove('rotate-down');
            } else {
                content.classList.add('details-open');
                icon.classList.add('rotate-down');
            }
        }

        function renderStats(data) {
            const mesIdx = new Date().getMonth();
            const moneyFormatter = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0});

            const NOMBRE_CATEGORIA_AHORRO = "Savings"; 
            const indexSavings = data.categorias.indexOf(NOMBRE_CATEGORIA_AHORRO);
            const montosSavings = indexSavings >= 0 ? data.detalleGastos[indexSavings] : data.pnl.map(() => 0);
            const pnlReal = data.pnl.map((valor, i) => Number(valor) + Number(montosSavings[i]));
            const gastosReales = data.gastosTotal.map((valor, i) => Number(valor) - Number(montosSavings[i]));

            const pnlMes = pnlReal[mesIdx];
            const ytd = pnlReal.reduce((a,b)=>a+b, 0);

            const ahorroDelMes = Number(montosSavings[mesIdx]) || 0;
            const cajaReal = pnlMes - ahorroDelMes;

            const elPnl = document.getElementById('kpi-pnl');
            const elMsg = document.getElementById('kpi-msg');
            elPnl.innerText = moneyFormatter.format(pnlMes);
            document.getElementById('kpi-ytd').innerText = moneyFormatter.format(ytd);

            if(pnlMes >= 0) {
                elPnl.className = "text-2xl font-black text-emerald-600";
                elMsg.innerHTML = `
                    <span class="block">‚úÖ Ganancia Neta</span>
                    <span class="block text-slate-400 font-normal mt-1 border-t pt-1">
                        Caja tras ahorro: <b class="${cajaReal >= 0 ? 'text-emerald-600' : 'text-rose-500'}">${moneyFormatter.format(cajaReal)}</b>
                    </span>
                `;
                elMsg.className = "text-xs font-bold text-emerald-600 mt-1";
            } else {
                elPnl.className = "text-2xl font-black text-rose-600";
                elMsg.innerHTML = "‚ö†Ô∏è D√©ficit Contable";
                elMsg.className = "text-xs font-bold text-rose-600 mt-1";
            }

            const ctx1 = document.getElementById('chartBalance').getContext('2d');
            if(chartBal) chartBal.destroy();
            chartBal = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: meses.map(m => m.substring(0,3)),
                    datasets: [
                        { type: 'line', label: 'Ahorro Total', data: pnlReal, borderColor: '#2563eb', borderWidth: 2, tension:0.4, order:0 },
                        { label: 'Ingresos', data: data.ingresos, backgroundColor: '#10b981', borderRadius:4, order:1 },
                        { label: 'Gastos', data: gastosReales, backgroundColor: '#f43f5e', borderRadius:4, order:2 },
                        { label: 'En Bolsillo', data: montosSavings, backgroundColor: '#f59e0b', borderRadius:4, order:3, stack: 'gastos' }
                    ]
                },
                options: { 
                    responsive:true, 
                    plugins:{
                        legend:{position:'bottom'},
                        tooltip: { callbacks: { label: function(c) { return (c.dataset.label||'') + ': ' + new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(c.parsed.y); } } }
                    }, 
                    scales:{ x:{grid:{display:false}}, y: { stacked: false } } 
                }
            });

            const catTotals = data.detalleGastos.map(row => row.reduce((a,b)=> Number(a)+Number(b),0));
            const totalIngresos = data.ingresos.reduce((a,b)=>a+b, 0); 
            const baseCalculo = totalIngresos > 0 ? totalIngresos : 1; 
            
            let categoriasConDatos = [];
            data.categorias.forEach((cat, index) => {
                if(catTotals[index] > 0) {
                    categoriasConDatos.push({
                        nombre: cat,
                        total: catTotals[index],
                        porcentaje: (catTotals[index] / baseCalculo * 100) 
                    });
                }
            });

            categoriasConDatos.sort((a,b) => b.total - a.total);

            const listaDiv = document.getElementById('lista-metas');
            listaDiv.innerHTML = ''; 

            if(categoriasConDatos.length === 0) {
                listaDiv.innerHTML = '<p class="text-center text-slate-400 text-sm">A√∫n no hay gastos registrados este a√±o.</p>';
            }

            categoriasConDatos.forEach((cat, idx) => {
                const nombre = cat.nombre;
                const realPct = cat.porcentaje.toFixed(1);
                const metaPct = METAS_PCT[nombre] || 5; 
                const formattedMoney = moneyFormatter.format(cat.total);

                let isGood = false;
                if(nombre === 'Savings') { isGood = true; } 
                else { isGood = parseFloat(realPct) <= metaPct; }

                const colorBarra = isGood ? 'bg-emerald-500' : 'bg-rose-500';
                const colorTexto = isGood ? 'text-slate-600' : 'text-rose-600';
                const icono = (nombre !== 'Savings' && !isGood) ? '<i class="fas fa-exclamation-circle text-rose-500"></i>' : '<i class="fas fa-check-circle text-emerald-500"></i>';

                const misMovimientos = (typeof movimientosGlobal !== 'undefined') ? movimientosGlobal.filter(m => m.categoria === nombre) : [];
                
                let detallesHTML = '';
                if(misMovimientos.length > 0) {
                    detallesHTML = misMovimientos.map(mov => `
                        <div class="flex justify-between items-center py-2 border-b border-slate-100 last:border-0 text-xs">
                            <div class="text-slate-500 w-16">${mov.fecha.substring(0,5)}</div>
                            <div class="flex-1 text-slate-700 font-medium truncate pr-2">${mov.detalle || '-'}</div>
                            <div class="text-slate-800 font-bold">${moneyFormatter.format(mov.monto)}</div>
                        </div>
                    `).join('');
                } else {
                    detallesHTML = '<p class="text-xs text-slate-400 italic py-2">Sin detalles disponibles.</p>';
                }

                const htmlItem = `
                    <div class="bg-slate-50 rounded-xl border border-slate-100 overflow-hidden">
                        <div onclick="toggleDetalle('${idx}')" class="p-3 cursor-pointer active:bg-slate-100 transition-colors">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-3">
                                    ${icono}
                                    <div class="flex flex-col text-left">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-bold text-slate-700 leading-none">${nombre}</span>
                                            <i id="icon-${idx}" class="fas fa-chevron-down text-[10px] text-slate-400 rotate-icon"></i>
                                        </div>
                                        <span class="text-[11px] text-slate-400 font-medium mt-1">${formattedMoney}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold ${colorTexto}">${realPct}%</span>
                                    <span class="text-[10px] text-slate-400"> / Meta ${metaPct}%</span>
                                </div>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div class="${colorBarra} h-2 rounded-full" style="width: ${Math.min(realPct, 100)}%"></div>
                            </div>
                        </div>
                        <div id="detalle-${idx}" class="details-content bg-slate-100 px-3">
                             <div class="py-2">
                                ${detallesHTML}
                             </div>
                        </div>
                    </div>
                `;
                listaDiv.innerHTML += htmlItem;
            });
        }

        // --- 3. L√ìGICA EKER (NUEVA FUNCI√ìN) ---
        function renderEker(data) {
            const moneyFormatter = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0});
            
            // 1. Calcular Ingresos Totales Reales
            const totalIngresos = data.ingresos.reduce((a,b)=>a+b, 0); 
            document.getElementById('eker-income').innerText = moneyFormatter.format(totalIngresos);

            // 2. Agrupar gastos por Jarr√≥n
            let jarTotals = { 'NEC':0, 'FFA':0, 'LTSS':0, 'EDU':0, 'PLAY':0, 'GIVE':0 };
            
            // Sumamos los totales de cada categor√≠a al jarr√≥n correspondiente
            const catTotals = data.detalleGastos.map(row => row.reduce((a,b)=> Number(a)+Number(b),0));
            
            data.categorias.forEach((catName, idx) => {
                const monto = catTotals[idx];
                const jarCode = EKER_MAP[catName] || 'NEC'; // Si no est√° mapeado, va a NEC por defecto
                jarTotals[jarCode] += monto;
            });

            // 3. Renderizar Tarjetas
            const container = document.getElementById('lista-eker');
            container.innerHTML = '';
            
            const baseCalc = totalIngresos > 0 ? totalIngresos : 1;

            Object.keys(JARS_INFO).forEach(jarKey => {
                const info = JARS_INFO[jarKey];
                const total = jarTotals[jarKey];
                const pct = (total / baseCalc * 100).toFixed(1);
                
                // Color sem√°foro: Verde si estamos debajo de la meta (excepto FFA que queremos que sea alto)
                let isGood = false;
                if(jarKey === 'FFA' || jarKey === 'LTSS' || jarKey === 'GIVE') {
                    // Para Ahorro e Inversi√≥n, m√°s es mejor (pero visualmente queremos ver cu√°nto llenamos)
                    isGood = true; 
                } else {
                    // Para Gastos, menos es mejor
                    isGood = parseFloat(pct) <= info.target;
                }

                const progressColor = isGood ? info.color : 'bg-rose-500'; // Si nos pasamos en NEC, sale rojo

                const html = `
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl">
                                    ${info.icon}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-700">${info.name}</h4>
                                    <p class="text-xs text-slate-400 font-mono">Meta: ${info.target}%</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <h3 class="font-black text-slate-800">${moneyFormatter.format(total)}</h3>
                                <p class="text-xs font-bold ${isGood ? 'text-slate-500' : 'text-rose-500'}">${pct}% Real</p>
                            </div>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                            <div class="${progressColor} h-full rounded-full transition-all duration-500" style="width: ${Math.min(pct, 100)}%"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }
    </script>
</body>
</html>
